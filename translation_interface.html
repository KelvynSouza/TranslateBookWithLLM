<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translating Books With LLMs</title>
<style>
    /* ... (Styles CSS) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        /* Fond d√©grad√© sombre et profond, inspir√© des interfaces tech */
        background: linear-gradient(135deg, #1A1A2E 0%, #0F0F1A 100%);
        min-height: 100vh;
        /* Couleur de texte g√©n√©rale pour un contraste clair */
        color: #E0E0E0;
        padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
        text-align: center;
        /* Blanc √©clatant pour le titre principal */
        color: #FFFFFF;
        margin-bottom: 40px;
    }
    .header h1 {
        font-size: 48px;
        margin-bottom: 10px;
        /* Ombre textuelle subtile pour un effet de profondeur */
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
    }
    .main-card {
        /* Fond de carte l√©g√®rement transparent ou tr√®s sombre pour un effet glassy */
        background: rgba(25, 25, 45, 0.85);
        border-radius: 20px;
        /* Ombre plus prononc√©e avec une l√©g√®re lueur bleut√©e */
        box-shadow: 0 20px 50px -10px rgba(0, 255, 255, 0.2);
        overflow: hidden;
        /* Bordure subtile pour d√©limiter la carte */
        border: 1px solid rgba(0, 255, 255, 0.1);
    }
    .card-header {
        /* D√©grad√© vibrant pour l'en-t√™te, rappelant les interfaces technologiques */
        background: linear-gradient(135deg, #00C9FF, #92FE9D);
        color: #1A1A2E; /* Texte sombre pour un contraste avec le d√©grad√© */
        padding: 30px;
        /* Effet de lueur interne subtil */
        box-shadow: inset 0 -5px 15px rgba(0, 201, 255, 0.3);
    }
    .card-body { padding: 30px; }
    .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        /* Couleur l√©g√®rement plus claire pour les labels */
        color: #B0B0B0;
    }
    .form-control {
        padding: 12px;
        /* Bordure et fond sombres */
        border: 2px solid #3A3A50;
        background-color: #28283C;
        border-radius: 8px;
        font-size: 16px;
        color: #E0E0E0; /* Couleur du texte dans les champs */
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    .form-control:focus {
        outline: none;
        /* Bordure et ombre lumineuses au focus */
        border-color: #00C9FF;
        box-shadow: 0 0 10px rgba(0, 201, 255, 0.5);
    }
    .file-upload {
        margin: 30px 0;
        padding: 60px;
        /* Bordure en pointill√©s n√©on */
        border: 3px dashed #00FFCC;
        border-radius: 15px;
        text-align: center;
        /* Fond sombre et l√©g√®rement transparent */
        background: rgba(40, 40, 60, 0.6);
        cursor: pointer;
        transition: all 0.3s;
        /* Texte plus clair */
        color: #B0B0B0;
    }
    .file-upload:hover {
        border-color: #00C9FF;
        background: rgba(0, 201, 255, 0.1);
    }
    .file-upload.dragging {
        border-color: #92FE9D;
        background: rgba(146, 254, 157, 0.15);
    }
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    .btn-primary {
        /* D√©grad√© de bouton "call to action" technologique */
        background: linear-gradient(135deg, #00C9FF, #92FE9D);
        color: #1A1A2E; /* Texte sombre pour un contraste */
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        /* Ombre avec lueur au hover */
        box-shadow: 0 10px 25px rgba(0, 201, 255, 0.4);
    }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-danger {
        /* Rouge plus profond et moins flashy */
        background-color: #C0392B;
        color: white;
    }
    .btn-danger:hover { background-color: #A93226; }
    .btn-danger:disabled { background-color: #C0392B; opacity: 0.6; cursor: not-allowed; }
    .progress-section {
        margin-top: 30px;
        padding: 30px;
        /* Fond l√©g√®rement plus clair que le corps pour la section */
        background: rgba(35, 35, 55, 0.7);
        border-radius: 15px;
        border: 1px solid #3A3A50;
        color: #E0E0E0;
    }
    .progress-bar-container {
        height: 30px;
        background: #3A3A50;
        border-radius: 15px;
        overflow: hidden;
        margin: 20px 0;
        /* Ombre interne subtile */
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
    }
    .progress-bar {
        height: 100%;
        /* D√©grad√© pour la barre de progression, style n√©on */
        background: linear-gradient(90deg, #00C9FF, #00FFCC);
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1A1A2E; /* Texte sombre pour la barre */
        font-weight: 600;
        /* Ombre interne pour un effet "rempli" */
        box-shadow: inset 0 0 8px rgba(0, 255, 204, 0.6);
    }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card {
        padding: 20px;
        /* Fond de carte statistique sombre */
        background: #28283C;
        border-radius: 10px;
        text-align: center;
        /* Ombre douce */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        /* Bordure fine pour la d√©limitation */
        border: 1px solid #3A3A50;
        color: #E0E0E0;
    }
    .stat-card h3 {
        font-size: 32px;
        /* Couleur des chiffres cl√©s */
        color: #00C9FF;
        margin-bottom: 5px;
        /* L√©g√®re ombre textuelle pour la clart√© */
        text-shadow: 0 0 5px rgba(0, 201, 255, 0.5);
    }
    .log-container {
        max-height: 200px;
        overflow-y: auto;
        /* Fond tr√®s sombre pour les logs, texte vert pour l'effet console */
        background: #000000;
        color: #00FF00; /* Vert n√©on pour les logs */
        padding: 15px;
        border-radius: 8px;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; /* Police monospace */
        font-size: 14px;
        margin-top: 15px;
        /* Bordure lumineuse pour le conteneur de logs */
        border: 1px solid rgba(0, 255, 0, 0.3);
    }
    .output-section {
        margin-top: 30px;
        padding: 30px;
        /* Fond de section de sortie */
        background: rgba(35, 35, 55, 0.7);
        border-radius: 15px;
        border: 1px solid #3A3A50;
        color: #E0E0E0;
    }
    .output-preview {
        margin-top: 15px;
        padding: 15px;
        /* Fond de pr√©visualisation sombre */
        background: #28283C;
        border: 1px solid #3A3A50;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        color: #E0E0E0;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }
    .advanced-toggle {
        margin: 20px 0;
        padding: 15px;
        /* Fond du toggle sombre */
        background: #28283C;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* Bordure fine pour d√©limiter */
        border: 1px solid #3A3A50;
        color: #E0E0E0;
        transition: background 0.3s;
    }
    .advanced-toggle:hover {
        background: #3A3A50;
        /* L√©g√®re lueur au hover */
        box-shadow: 0 0 10px rgba(0, 201, 255, 0.3);
    }
    .advanced-settings {
        margin-top: 15px;
        padding: 20px;
        /* Fond des param√®tres avanc√©s */
        background: #1F1F30;
        border-radius: 8px;
        border: 1px solid #3A3A50;
        color: #E0E0E0;
    }
    .hidden { display: none !important; }
    .message {
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        /* Texte en gras pour les messages */
        font-weight: 600;
    }
    .error {
        /* Rouge plus profond avec bordure et texte contrastants */
        background: #4A1B1B;
        border: 1px solid #8A2D2D;
        color: #FFC0C0;
    }
    .success {
        /* Vert n√©on avec bordure et texte contrastants */
        background: #1B4A1B;
        border: 1px solid #2D8A2D;
        color: #C0FFC0;
    }
    .info {
        /* Bleu tech avec bordure et texte contrastants */
        background: #1B1B4A;
        border: 1px solid #2D2D8A;
        color: #C0C0FF;
    }
    #fileListContainer {
        margin-top: 10px;
        max-height: 150px;
        overflow-y: auto;
        /* Fond de liste de fichiers sombre */
        background: #28283C;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #3A3A50;
        color: #B0B0B0;
    }
    #fileListContainer li {
        list-style-type: none;
        padding: 5px;
        border-bottom: 1px solid #3A3A50; /* Bordure plus sombre pour les √©l√©ments */
    }
    #fileListContainer li:last-child { border-bottom: none; }
    .file-status {
        font-style: italic;
        color: #00FFCC; /* Couleur n√©on pour le statut des fichiers */
        font-size: 0.9em;
        margin-left: 10px;
    }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Translating Books With LLMs</h1>
            <p>Translate documents with local language models</p>
        </div>

        <div class="main-card">
            <div class="card-header">
                <h2>‚öôÔ∏è Translation Configuration</h2>
            </div>

            <div class="card-body">
                <div class="config-grid">
                    <div class="form-group">
                        <label>Ollama API Endpoint</label>
                        <input type="text" class="form-control" id="apiEndpoint" value="http://localhost:11434/api/generate">
                    </div>

                    <div class="form-group">
                        <label>LLM Model</label>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control" id="model" style="flex: 1;">
                                <option value="">Loading models...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadAvailableModels()" title="Refresh model list">üîÑ</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Source Language</label>
                        <select class="form-control" id="sourceLang" onchange="checkCustomSourceLanguage(this)">
                            <option value="English">English</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Spanish">Spanish</option>
                            <option value="French">French</option>
                            <option value="German">German</option>
                            <option value="Italian">Italian</option>
                            <option value="Portuguese">Portuguese</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Arabic">Arabic</option>
                            <option value="Bengali">Bengali</option>
                            <option value="Russian">Russian</option>
                            <option value="Urdu">Urdu</option>
                            <option value="Other">Other (Specify)</option>
                        </select>
                        <input type="text" class="form-control" id="customSourceLang" placeholder="Enter custom source language" style="margin-top: 10px; display: none;">
                    </div>

                    <div class="form-group">
                        <label>Target Language</label>
                        <select class="form-control" id="targetLang" onchange="checkCustomTargetLanguage(this)">
                            <option value="French">French</option>
                            <option value="English">English</option>
                            <option value="Chinese">Chinese</option>
                            <option value="Spanish">Spanish</option>
                            <option value="German">German</option>
                            <option value="Italian">Italian</option>
                            <option value="Portuguese">Portuguese</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Arabic">Arabic</option>
                            <option value="Bengali">Bengali</option>
                            <option value="Russian">Russian</option>
                            <option value="Urdu">Urdu</option>
                            <option value="Other">Other (Specify)</option>
                        </select>
                        <input type="text" class="form-control" id="customTargetLang" placeholder="Enter custom target language (e.g., Portuguese)" style="margin-top: 10px; display: none;">
                    </div>
                     <div class="form-group">
                        <label>Output Filename Pattern</label>
                        <input type="text" class="form-control" id="outputFilenamePattern" value="translated_{originalName}.txt" title="Use {originalName} as placeholder for original filename without extension.">
                        <small>Example: `translated_{originalName}_to_FR.txt`</small>
                    </div>
                </div>

                <div class="advanced-toggle" onclick="toggleAdvanced()">
                    <span>üîß Advanced Settings</span>
                    <span id="advancedIcon">‚ñº</span>
                </div>

                <div id="advancedSettings" class="advanced-settings hidden">
                    <div class="config-grid">
                        <div class="form-group">
                            <label>Chunk Size (lines)</label>
                            <input type="number" class="form-control" id="chunkSize" value="25" min="5" max="200">
                        </div>
                        <div class="form-group">
                            <label>Request Timeout (sec)</label>
                            <input type="number" class="form-control" id="timeout" value="180" min="30" max="600">
                        </div>
                        <div class="form-group">
                            <label>Context Window (tokens)</label>
                            <input type="number" class="form-control" id="contextWindow" value="4096" min="1024" max="32768">
                        </div>
                        <div class="form-group">
                            <label>Max Retries per Chunk</label>
                            <input type="number" class="form-control" id="maxAttempts" value="2" min="1" max="5">
                        </div>
                         <div class="form-group">
                            <label>Retry Delay (sec)</label>
                            <input type="number" class="form-control" id="retryDelay" value="2" min="1" max="60">
                        </div>
                    </div>
                </div>

                <div class="file-upload" id="fileUpload" onclick="document.getElementById('fileInput').click()">
                    <h3>üìÅ Drag & Drop your .txt files here</h3>
                    <p>or click to select</p>
                    <input type="file" id="fileInput" accept=".txt" style="display: none;" onchange="handleFileSelect(event)" multiple> </div>

                <div id="fileInfo" class="hidden" style="margin-bottom: 20px;">
                    <h4>Selected Files:</h4>
                    <ul id="fileListContainer"></ul> <button class="btn" onclick="resetFiles()" style="background: #e5e7eb; color: #374151; margin-top:10px;">‚ùå Clear All Files</button>
                </div>


                <div id="messages"></div>

                <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 15px;">
                    <button class="btn btn-primary" id="translateBtn" onclick="startBatchTranslation()" disabled> ‚ñ∂Ô∏è Start Translation Batch
                    </button>
                    <button class="btn btn-danger hidden" id="interruptBtn" onclick="interruptCurrentTranslation()"> ‚èπÔ∏è Interrupt Current & Stop Batch
                    </button>
                </div>

                <div id="progressSection" class="progress-section hidden">
                    <h3 id="currentFileProgressTitle">üìä Translation Progress</h3>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card"><h3 id="totalChunks">0</h3><p>Total Chunks</p></div>
                        <div class="stat-card"><h3 id="completedChunks">0</h3><p>Completed</p></div>
                        <div class="stat-card"><h3 id="failedChunks">0</h3><p>Failed</p></div>
                        <div class="stat-card"><h3 id="elapsedTime">0s</h3><p>Time Elapsed</p></div>
                    </div>
                    <h4>üíª Activity Log (Current File)</h4>
                    <div class="log-container" id="logContainer"></div>
                </div>

                <div id="outputSection" class="output-section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 id="outputTitle">üìÑ Translation Result</h3>
                        <button class="btn btn-primary" id="downloadBtn" onclick="downloadLastTranslation()" disabled> ‚¨áÔ∏è Download Last File
                        </button>
                    </div>
                    <div class="output-preview" id="outputPreview"></div>
                    <p style="margin-top: 15px; color: #6b7280; font-size: 14px;">
                        ‚ÑπÔ∏è Preview limited to the first 1000 characters. Full text saved to server.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let filesToProcess = [];
        let translationQueue = [];
        let currentProcessingJob = null;
        let isBatchActive = false;
        let lastCompletedJobData = null;

        const API_BASE_URL = `${window.location.protocol}//${window.location.hostname}:5000`;
        const socket = io(API_BASE_URL);
        
        socket.on('connect', () => { 
            console.log('WebSocket connected to:', API_BASE_URL); 
            addLog('‚úÖ WebSocket connection to server established.');
        });
        socket.on('disconnect', () => { 
            console.log('WebSocket disconnected.'); 
            addLog('‚ùå WebSocket connection lost.'); 
            if (isBatchActive && currentProcessingJob) {
                showMessage('Connection lost. Batch paused. Reconnect to resume or reset.', 'error');
            }
        });
        
        socket.on('translation_update', (data) => {
            if (currentProcessingJob && data.translation_id === currentProcessingJob.translationId) {
                handleTranslationUpdate(data);
            } else {
                console.log("Received update for a different/old job:", data.translation_id);
            }
        });

        function updateFileStatusInList(fileName, newStatus, translationId = null) {
            const fileListItem = document.querySelector(`#fileListContainer li[data-filename="${fileName}"] .file-status`);
            if (fileListItem) {
                fileListItem.textContent = `(${newStatus})`;
            }
            const fileObj = filesToProcess.find(f => f.name === fileName);
            if (fileObj) {
                fileObj.status = newStatus;
                if (translationId) fileObj.translationId = translationId;
            }
        }
        
        function finishCurrentFileTranslationUI(statusMessage, messageType, resultData) {
            if (!currentProcessingJob) return;

            const currentFile = currentProcessingJob.fileRef;
            currentFile.status = resultData.status || 'unknown_error';
            currentFile.result = resultData.result;

            if (resultData && resultData.result) {
                translatedContentFromServer = resultData.result;
                document.getElementById('outputPreview').textContent = 
                    (translatedContentFromServer || "").substring(0, 1000) + 
                    ((translatedContentFromServer || "").length > 1000 ? '...' : '');
                document.getElementById('outputSection').classList.remove('hidden');
                document.getElementById('outputTitle').textContent = `üìÑ Translation Result for ${currentFile.name}`;
                
                lastCompletedJobData = {
                    translationId: currentProcessingJob.translationId,
                    outputFilename: currentFile.outputFilename,
                    status: resultData.status
                };
                document.getElementById('downloadBtn').disabled = !(lastCompletedJobData.outputFilename && (lastCompletedJobData.status === 'completed' || lastCompletedJobData.status === 'interrupted'));

            } else {
                 document.getElementById('downloadBtn').disabled = true;
            }

            showMessage(statusMessage, messageType);
            updateFileStatusInList(currentFile.name, resultData.status === 'completed' ? 'Completed' : (resultData.status === 'interrupted' ? 'Interrupted' : 'Error'));
            
            currentProcessingJob = null;
            processNextFileInQueue(); 
        }

        function handleTranslationUpdate(data) {
            if (!currentProcessingJob || data.translation_id !== currentProcessingJob.translationId) return;

            const currentFile = currentProcessingJob.fileRef;

            if (data.log) addLog(`[${currentFile.name}] ${data.log}`);
            if (data.progress !== undefined) updateProgress(data.progress);
            
            if (data.stats) {
                document.getElementById('totalChunks').textContent = data.stats.total_chunks || '0';
                document.getElementById('completedChunks').textContent = data.stats.completed_chunks || '0';
                document.getElementById('failedChunks').textContent = data.stats.failed_chunks || '0';
                if (data.stats.elapsed_time !== undefined) {
                    document.getElementById('elapsedTime').textContent = data.stats.elapsed_time.toFixed(1) + 's';
                }
            }
            
            if (data.status === 'completed') {
                finishCurrentFileTranslationUI(`‚úÖ ${currentFile.name}: Translation completed!`, 'success', data);
            } else if (data.status === 'interrupted') {
                finishCurrentFileTranslationUI(`‚ÑπÔ∏è ${currentFile.name}: Translation interrupted.`, 'info', data);
            } else if (data.status === 'error') {
                finishCurrentFileTranslationUI(`‚ùå ${currentFile.name}: Error - ${data.error || 'Unknown error.'}`, 'error', data);
            } else if (data.status === 'running') {
                 // This is expected when a file starts processing
                 document.getElementById('progressSection').classList.remove('hidden');
                 document.getElementById('currentFileProgressTitle').textContent = `üìä Translating: ${currentFile.name}`;
                 showMessage(`Translation in progress for ${currentFile.name}...`, 'info');
                 updateFileStatusInList(currentFile.name, 'Processing');
            }
        }
        
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (!response.ok) throw new Error('Server health check failed');
                addLog('Server health check OK.');
                loadAvailableModels();
                const configResponse = await fetch(`${API_BASE_URL}/api/config`);
                if (configResponse.ok) {
                    const defaultConfig = await configResponse.json();
                    document.getElementById('apiEndpoint').value = defaultConfig.api_endpoint || 'http://localhost:11434/api/generate';
                    document.getElementById('chunkSize').value = defaultConfig.chunk_size || 25;
                    document.getElementById('timeout').value = defaultConfig.timeout || 180;
                    document.getElementById('contextWindow').value = defaultConfig.context_window || 4096;
                    document.getElementById('maxAttempts').value = defaultConfig.max_attempts || 2;
                    document.getElementById('retryDelay').value = defaultConfig.retry_delay || 2;
                }
            } catch (error) {
                showMessage(`‚ö†Ô∏è Server unavailable at ${API_BASE_URL}. Ensure Python server is running. ${error.message}`, 'error');
                addLog(`‚ùå Failed to connect to server or load config: ${error.message}`);
            }
        });
        
        async function loadAvailableModels() {
            const modelSelect = document.getElementById('model');
            modelSelect.innerHTML = '<option value="">Loading models...</option>';
            try {
                const currentApiEp = document.getElementById('apiEndpoint').value;
                const response = await fetch(`${API_BASE_URL}/api/models?api_endpoint=${encodeURIComponent(currentApiEp)}`);
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || `HTTP error ${response.status}`);
                }
                const data = await response.json();
                modelSelect.innerHTML = '';
                
                if (data.models && data.models.length > 0) {
                    data.models.forEach(modelName => {
                        const option = document.createElement('option');
                        option.value = modelName; option.textContent = modelName;
                        if (modelName === data.default) option.selected = true;
                        modelSelect.appendChild(option);
                    });
                    addLog(`‚úÖ ${data.count} LLM model(s) loaded. Default: ${data.default}`);
                    if (data.default && !data.models.includes(data.default)) {
                        showMessage(`‚ÑπÔ∏è Default model '${data.default}' (from server) not found. Using '${data.models[0]}'.`, 'info');
                    }
                } else {
                    const errorMessage = data.error || (currentApiEp.includes('localhost') || currentApiEp.includes('127.0.0.1') ? 
                                        '‚ö†Ô∏è No LLM models found. Ensure Ollama is running, accessible at the specified endpoint, and models are installed (e.g., ollama pull mistral).' :
                                        '‚ö†Ô∏è No LLM models found. Ensure Ollama is accessible at the specified endpoint and models are installed.');
                    showMessage(errorMessage, 'error');
                    modelSelect.innerHTML = '<option value="">No models available</option>';
                }
            } catch (error) {
                showMessage(`‚ùå Error fetching models: ${error.message}`, 'error');
                addLog(`‚ùå Failed to retrieve model list: ${error.message}`);
                modelSelect.innerHTML = '<option value="">Error loading models</option>';
            }
        }

        const fileUploadArea = document.getElementById('fileUpload');
        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragging'); });
        fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragging'));
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault(); fileUploadArea.classList.remove('dragging');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    if (file.type === 'text/plain') addFileToList(file);
                    else showMessage(`File '${file.name}' is not a .txt file and was skipped.`, 'error');
                });
                updateFileDisplay();
            }
        });

        function toggleAdvanced() {
            const settings = document.getElementById('advancedSettings');
            document.getElementById('advancedIcon').textContent = settings.classList.toggle('hidden') ? '‚ñº' : '‚ñ≤';
        }
        function checkCustomSourceLanguage(selectElement) {
            const customLangInput = document.getElementById('customSourceLang');
            customLangInput.style.display = (selectElement.value === 'Other') ? 'block' : 'none';
            if (selectElement.value === 'Other') customLangInput.focus();
        }
        function checkCustomTargetLanguage(selectElement) {
            const customLangInput = document.getElementById('customTargetLang');
            customLangInput.style.display = (selectElement.value === 'Other') ? 'block' : 'none';
            if (selectElement.value === 'Other') customLangInput.focus();
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    if (file.type === 'text/plain') addFileToList(file);
                    else showMessage(`File '${file.name}' is not a .txt file and was skipped.`, 'error');
                });
                updateFileDisplay();
            }
             document.getElementById('fileInput').value = '';
        }
        
        function addFileToList(file) {
            if (filesToProcess.find(f => f.name === file.name)) {
                showMessage(`File '${file.name}' is already in the list.`, 'info');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const originalNameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                const outputPattern = document.getElementById('outputFilenamePattern').value || "translated_{originalName}.txt";
                const outputFilename = outputPattern.replace("{originalName}", originalNameWithoutExt);

                filesToProcess.push({
                    name: file.name,
                    content: e.target.result,
                    status: 'Queued',
                    outputFilename: outputFilename,
                    size: file.size,
                    translationId: null,
                    result: null
                });
                updateFileDisplay();
            };
            reader.readAsText(file);
        }

        function updateFileDisplay() {
            const fileListContainer = document.getElementById('fileListContainer');
            fileListContainer.innerHTML = '';

            if (filesToProcess.length > 0) {
                filesToProcess.forEach(file => {
                    const li = document.createElement('li');
                    li.setAttribute('data-filename', file.name);
                    li.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB) `;
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'file-status';
                    statusSpan.textContent = `(${file.status})`;
                    li.appendChild(statusSpan);
                    fileListContainer.appendChild(li);
                });
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('translateBtn').disabled = isBatchActive;
            } else {
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('translateBtn').disabled = true;
            }
        }

        function resetFiles() {
            filesToProcess = [];
            translationQueue = [];
            currentProcessingJob = null;
            isBatchActive = false;
            lastCompletedJobData = null;

            document.getElementById('fileInput').value = '';
            updateFileDisplay();

            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('translateBtn').innerHTML = '‚ñ∂Ô∏è Start Translation Batch';
            document.getElementById('translateBtn').disabled = true;
            document.getElementById('interruptBtn').classList.add('hidden');
            document.getElementById('interruptBtn').disabled = false;
            document.getElementById('interruptBtn').innerHTML = '‚èπÔ∏è Interrupt Current & Stop Batch';
            
            document.getElementById('customSourceLang').style.display = 'none';
            document.getElementById('customTargetLang').style.display = 'none';
            document.getElementById('sourceLang').selectedIndex = 0;
            document.getElementById('targetLang').selectedIndex = 0;
            updateProgress(0);
            showMessage('', '');
            addLog("Form and file list reset.");
        }

        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = text ? `<div class="message ${type}">${text}</div>` : '';
        }
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function earlyValidationFail(message) {
            showMessage(message, 'error');
            isBatchActive = false;
            document.getElementById('translateBtn').disabled = filesToProcess.length === 0;
            document.getElementById('translateBtn').innerHTML = '‚ñ∂Ô∏è Start Translation Batch';
            document.getElementById('interruptBtn').classList.add('hidden');
            return false;
        }

        // Start batch translation
        async function startBatchTranslation() {
            if (isBatchActive || filesToProcess.length === 0) return;

            let sourceLanguageVal = document.getElementById('sourceLang').value;
            if (sourceLanguageVal === 'Other') {
                sourceLanguageVal = document.getElementById('customSourceLang').value.trim();
                if (!sourceLanguageVal) return earlyValidationFail('Please specify the custom source language for the batch.');
            }
            let targetLanguageVal = document.getElementById('targetLang').value;
            if (targetLanguageVal === 'Other') {
                targetLanguageVal = document.getElementById('customTargetLang').value.trim();
                if (!targetLanguageVal) return earlyValidationFail('Please specify the custom target language for the batch.');
            }
            const selectedModel = document.getElementById('model').value;
            if (!selectedModel) return earlyValidationFail('Please select an LLM model for the batch.');
            const ollamaApiEndpoint = document.getElementById('apiEndpoint').value.trim();
            if (!ollamaApiEndpoint) return earlyValidationFail('Ollama API Endpoint cannot be empty for the batch.');

            isBatchActive = true;
            translationQueue = [...filesToProcess];
            
            document.getElementById('translateBtn').disabled = true;
            document.getElementById('translateBtn').innerHTML = '‚è≥ Batch in Progress...';
            document.getElementById('interruptBtn').classList.remove('hidden');
            document.getElementById('interruptBtn').disabled = false;
            
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('logContainer').innerHTML = '';

            addLog(`üöÄ Batch translation started for ${translationQueue.length} file(s).`);
            showMessage(`Batch of ${translationQueue.length} file(s) initiated.`, 'info');
            
            processNextFileInQueue();
        }

        async function processNextFileInQueue() {
            if (currentProcessingJob) return; // Already processing one

            if (translationQueue.length === 0) {
                isBatchActive = false;
                document.getElementById('translateBtn').disabled = filesToProcess.length === 0;
                document.getElementById('translateBtn').innerHTML = '‚ñ∂Ô∏è Start Translation Batch';
                document.getElementById('interruptBtn').classList.add('hidden');
                showMessage('‚úÖ Batch translation completed for all files!', 'success');
                addLog('üèÅ All files in the batch have been processed.');
                document.getElementById('currentFileProgressTitle').textContent = `üìä Batch Completed`;
                return;
            }

            const fileToTranslate = translationQueue.shift();

            updateProgress(0);
            ['totalChunks', 'completedChunks', 'failedChunks'].forEach(id => document.getElementById(id).textContent = '0');
            document.getElementById('elapsedTime').textContent = '0s';
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('outputSection').classList.add('hidden');
             document.getElementById('downloadBtn').disabled = true;


            document.getElementById('currentFileProgressTitle').textContent = `üìä Translating: ${fileToTranslate.name}`;
            document.getElementById('progressSection').classList.remove('hidden');
            addLog(`‚ñ∂Ô∏è Starting translation for: ${fileToTranslate.name}`);
            updateFileStatusInList(fileToTranslate.name, 'Preparing...');

            let sourceLanguageVal = document.getElementById('sourceLang').value;
            if (sourceLanguageVal === 'Other') sourceLanguageVal = document.getElementById('customSourceLang').value.trim();
            let targetLanguageVal = document.getElementById('targetLang').value;
            if (targetLanguageVal === 'Other') targetLanguageVal = document.getElementById('customTargetLang').value.trim();

            const config = {
                text: fileToTranslate.content,
                source_language: sourceLanguageVal,
                target_language: targetLanguageVal,
                model: document.getElementById('model').value,
                api_endpoint: document.getElementById('apiEndpoint').value,
                chunk_size: parseInt(document.getElementById('chunkSize').value),
                timeout: parseInt(document.getElementById('timeout').value),
                context_window: parseInt(document.getElementById('contextWindow').value),
                max_attempts: parseInt(document.getElementById('maxAttempts').value),
                retry_delay: parseInt(document.getElementById('retryDelay').value),
                output_filename: fileToTranslate.outputFilename 
            };

            try {
                const response = await fetch(`${API_BASE_URL}/api/translate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Server error ${response.status} for ${fileToTranslate.name}.`);
                }
                const data = await response.json();
                currentProcessingJob = { fileRef: fileToTranslate, translationId: data.translation_id };
                fileToTranslate.translationId = data.translation_id;
                updateFileStatusInList(fileToTranslate.name, 'Submitted', data.translation_id);

            } catch (error) {
                addLog(`‚ùå Error initiating translation for ${fileToTranslate.name}: ${error.message}`);
                showMessage(`Error starting ${fileToTranslate.name}: ${error.message}`, 'error');
                updateFileStatusInList(fileToTranslate.name, 'Initiation Error');
                currentProcessingJob = null;
                processNextFileInQueue();
            }
        }
        
        async function interruptCurrentTranslation() {
            if (!isBatchActive || !currentProcessingJob) {
                showMessage('No active translation to interrupt.', 'info');
                return;
            }

            const fileToInterrupt = currentProcessingJob.fileRef;
            const tidToInterrupt = currentProcessingJob.translationId;

            document.getElementById('interruptBtn').disabled = true;
            document.getElementById('interruptBtn').innerHTML = '‚è≥ Interrupting...';
            addLog(`üõë User requested interruption for ${fileToInterrupt.name} (ID: ${tidToInterrupt}). This will stop the batch.`);
            translationQueue = [];

            try {
                const response = await fetch(`${API_BASE_URL}/api/translation/${tidToInterrupt}/interrupt`, { method: 'POST' });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.message || `Failed to send interrupt signal for ${fileToInterrupt.name}.`);
                }
                showMessage(`‚ÑπÔ∏è Interruption for ${fileToInterrupt.name} requested. Batch will stop after this file.`, 'info');
            } catch (error) {
                showMessage(`‚ùå Error sending interruption for ${fileToInterrupt.name}: ${error.message}`, 'error');
                 document.getElementById('interruptBtn').disabled = false;
                 document.getElementById('interruptBtn').innerHTML = '‚èπÔ∏è Interrupt Current & Stop Batch';
            }
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.round(percent) + '%';
        }

        function downloadLastTranslation() {
            if (!lastCompletedJobData || !lastCompletedJobData.translationId) {
                showMessage('No completed translation available for download, or ID missing.', 'error'); return;
            }
            if (lastCompletedJobData.status !== 'completed' && lastCompletedJobData.status !== 'interrupted') {
                 showMessage(`Cannot download file as its status is '${lastCompletedJobData.status}'.`, 'error'); return;
            }
            const downloadUrl = `${API_BASE_URL}/api/download/${lastCompletedJobData.translationId}`;
            addLog(`Initiating download for ${lastCompletedJobData.outputFilename} from: ${downloadUrl}`);
            window.location.href = downloadUrl;
        }

    </script>
</body>
</html>